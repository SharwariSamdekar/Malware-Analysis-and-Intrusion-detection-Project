import json
import csv
import os


def main() :
	basepath = 'malware/'
	cs = open("Test_Features.csv","w")
	Writer = csv.writer(cs)
	cd = os.getcwd()
	new = os.chdir(basepath)
	for jfs in os.listdir(new):
		listfeat = list()
		with open(jfs,'r') as f :
			file = json.load(f)
			try :
				count = 0
				for items in file['network']['udp'] :
					count = count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['network']['http'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['network']['icmp'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['network']['smtp'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['network']['tcp'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['network']['hosts'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['behavior']['summary']['file_created'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['behavior']['summary']['file_deleted'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['behavior']['summary']['directory_created'] :
					count =count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				s = set()
				for item in file['behavior']['summary']['dll_loaded'] :
					s.add(item)
				listfeat.append(len(s))
			except KeyError as ke :
				listfeat.append(-1)
			try :
				s = set()
				for item in file['behavior']['summary']['regkey_opened'] :
					s.add(item)
				listfeat.append(len(s))
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['behavior']['summary']['file_written'] :
					count = count + 1
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				count = 0
				for item in file['behavior']['apistats'] :
					m = int(item)
					if(count < m) :
						count = m
				listfeat.append(count)
			except KeyError as ke :
				listfeat.append(-1)
			try :
				# Checking for dlls in order GetAdaptersAddress, CryptAquireContext,DeviceIOControl, GetKeyState LdrGetProcedureAddress, InternetOpen, LdrLoadDll
				items = file['behavior']['apistats'][str(count)] 
				if "GetAdaptersAddress" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "CryptAquireContext" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "DeviceIOControl" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "GetKeyState" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "LdrGetProcedureAddress" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "LdrLoadDll" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)

				if "InternetOpen" in items :
					listfeat.append(1)
				else :
					listfeat.append(0)
				
			except KeyError as ke :
				print(ke)

		# listfeat.append(0)
		Writer.writerow(listfeat)
	f.close()

# Driver Code 
if __name__ == '__main__': 
      
    # Calling main() function 
    main() 
